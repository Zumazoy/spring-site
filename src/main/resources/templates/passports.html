<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление паспортами</title>
    <link rel="stylesheet" href="/style.css">
    <script src="/script.js" defer></script>
</head>
<body>
<div id="errorNotification" class="error-notification"
     th:if="${validationErrors != null and not validationErrors.isEmpty()}">
    <span class="close-btn" onclick="closeErrorNotification()">×</span>
    <strong>Ошибки при добавлении:</strong>
    <ul id="errorList" class="error-list">
        <li th:each="error : ${validationErrors}" th:text="${error.value}"></li>
    </ul>
</div>
<div id="updateErrorNotification" class="error-notification"
     th:if="${updateValidationErrors != null and not updateValidationErrors.isEmpty()}">
    <span class="close-btn" onclick="closeUpdateErrorNotification()">×</span>
    <strong>Ошибки при изменении:</strong>
    <ul id="updateErrorList" class="error-list">
        <li th:each="error : ${updateValidationErrors}" th:text="${error.value}"></li>
    </ul>
</div>
<div id="deleteErrorNotification" class="error-notification"
     th:if="${deleteErrors != null and not deleteErrors.isEmpty()}">
    <span class="close-btn" onclick="closeUpdateErrorNotification()">×</span>
    <strong>Ошибки при удалении:</strong>
    <ul id="deleteErrorList" class="error-list">
        <li th:each="error : ${deleteErrors}" th:text="${error}"></li>
    </ul>
</div>

<header>
    <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
        <a href="/admin" class="admin-btn">← Админ меню</a>
        <h1>Управление паспортами</h1>
        <div style="width: 100px;"></div>
    </div>
</header>

<div class="container">
    <section class="search-section">
        <h2>Поиск паспортов</h2>
        <form class="search-form" action="/admin/passports/search" method="get">
            <input type="text" maxlength="100" name="keyword" placeholder="Введите ключевое слово" th:value="${keyword}" required>
            <select name="searchBy">
                <option value="id" th:selected="${searchBy == 'id'}">ID</option>
                <option value="serial" th:selected="${searchBy == 'serial'}">Серия</option>
                <option value="number" th:selected="${searchBy == 'number'}">Номер</option>
            </select>
            <button type="submit">Поиск</button>
            <a href="/admin/passports">
                <button type="button">Сбросить поиск</button>
            </a>
        </form>
    </section>

    <section>
        <h2>Добавить паспорт</h2>
        <form action="/admin/passports/add" method="post" th:object="${passport}">
            <div class="form-grid">
                <div class="form-group">
                    <label>Серия (4 цифры)</label>
                    <input type="text" th:field="*{serial}" pattern="[1-9]{1}[0-9]{3}" minlength="4" maxlength="4"
                           placeholder="1234" required>
                </div>
                <div class="form-group">
                    <label>Номер (6 цифр)</label>
                    <input type="text" th:field="*{number}" pattern="[1-9]{1}[0-9]{5}" minlength="6" maxlength="6"
                           placeholder="123456" required>
                </div>
                <div class="form-group">
                    <label>Дата выдачи</label>
                    <input type="date" class="dateForm" th:field="*{datePassport}" required>
                </div>
            </div>
            <button type="submit">Добавить паспорт</button>
        </form>
    </section>

    <section>
        <h2>Список паспортов</h2>
        <ol>
            <th:block th:each="passport : ${passports}">
                <li>
                    <div class="user-info">
                        <span th:text="'ID: ' + ${passport.id} + ' |'"></span>
                        <span th:text="'Серия: ' + ${passport.serial} + ' |'"></span>
                        <span th:text="'Номер: ' + ${passport.number} + ' |'"></span>
                        <span th:text="'Дата выдачи: ' + ${passport.datePassport}"></span>
                        <span th:if="${passport.user != null}"
                              th:text="'| Владелец: ' + ${passport.user.login}"></span>
                    </div>
                    <form id="update-form-${passport.id}" action="/admin/passports/update" method="post">
                        <input type="hidden" name="currentPage" th:value="${currentPage}">
                        <input type="hidden" name="id" th:value="${passport.id}"/>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Серия (4 цифры)</label>
                                <input type="text" name="serial" pattern="[1-9]{1}[0-9]{3}" minlength="4" maxlength="4"
                                       placeholder="Новая серия" th:attr="data-passportid=${passport.id}"
                                       th:value="${passport.serial}">
                            </div>
                            <div class="form-group">
                                <label>Номер (6 цифр)</label>
                                <input type="text" name="number" pattern="[1-9]{1}[0-9]{5}" minlength="6" maxlength="6"
                                       placeholder="Новый номер" th:attr="data-passportid=${passport.id}"
                                       th:value="${passport.number}">
                            </div>
                            <div class="form-group">
                                <label>Дата выдачи</label>
                                <input type="date" name="datePassport" class="dateForm"
                                       th:attr="data-passportid=${passport.id}"
                                       th:value="${passport.datePassport}">
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button type="submit">Обновить</button>
                            <button type="button" th:onclick="'confirmDelete(' + ${passport.id} + ')'"
                                    class="btn-danger">Удалить</button>
                        </div>
                    </form>
                    <form th:id="'delete-form-' + ${passport.id}" action="/admin/passports/delete" method="post" style="display: none;">
                        <input type="hidden" name="id" th:value="${passport.id}"/>
                    </form>
                </li>
            </th:block>
        </ol>

        <div class="pagination" th:if="${totalPages > 1}">
            <!-- Назад -->
            <a th:if="${currentPage > 0}"
               th:href="${(keyword != null and !#strings.isEmpty(keyword)) ?
                 '/admin/passports/search?keyword=' + keyword + '&searchBy=' + searchBy + '&page=' + (currentPage - 1) :
                 '/admin/passports?page=' + (currentPage - 1)}">← Назад</a>

            <!-- Номера страниц -->
            <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                <a th:if="${i != currentPage}" class="pages"
                   th:href="${(keyword != null and !#strings.isEmpty(keyword)) ?
                             '/admin/passports/search?keyword=' + keyword + '&searchBy=' + searchBy + '&page=' + i :
                             '/admin/passports?page=' + i}"
                   th:text="${i + 1}"></a>
                <span class="currentPage" th:if="${i == currentPage}" th:text="${i + 1}"></span>
            </span>

            <!-- Вперед -->
            <a th:if="${currentPage < totalPages - 1}"
               th:href="${(keyword != null and !#strings.isEmpty(keyword)) ?
                 '/admin/passports/search?keyword=' + keyword + '&searchBy=' + searchBy + '&page=' + (currentPage + 1) :
                 '/admin/passports?page=' + (currentPage + 1)}">Вперед →</a>
        </div>
    </section>
</div>
</body>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const errors = /*[[${validationErrors}]]*/ {};
        if (errors && Object.keys(errors).length > 0) {
            highlightAddErrorFields(errors);
            showErrorNotification(errors);
        }

        const updateErrors = /*[[${updateValidationErrors}]]*/ {};
        if (updateErrors && Object.keys(updateErrors).length > 0) {
            highlightUpdateErrorFields(updateErrors);
            showUpdateErrorNotification(updateErrors);
        }

        const deleteErrors = /*[[${deleteErrors}]]*/ {};
        if (deleteErrors && Object.keys(deleteErrors).length > 0) {
            showDeleteErrorNotification(deleteErrors);
        }
    });

    const elements = document.getElementsByClassName('dateForm');
    for (let el of elements) {
        el.min = new Date("1800-01-02T00:00:00").toISOString().split('T')[0];
        el.max = new Date().toISOString().split('T')[0];
    }

    function highlightAddErrorFields(errors) {
        document.querySelectorAll('.add-error-field').forEach(el => {
            el.classList.remove('add-error-field');
        });

        for (const field in errors) {
            const input = document.querySelector(`form[action='/admin/passports/add'] [name="${field}"],
                                              form[action='/admin/passports/add'] [th\\:field="*{${field}}"]`);
            if (input) {
                input.classList.add('add-error-field');
                if (Object.keys(errors).indexOf(field) === 0) {
                    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
    }

    function highlightUpdateErrorFields(errors) {
        document.querySelectorAll('.update-error-field').forEach(el => {
            el.classList.remove('update-error-field');
        });

        for (const field in errors) {
            const parts = field.split('_');
            if (parts.length >= 3 && parts[0] === "update") {
                const fieldName = parts[1];
                const passportId = parts[2];

                const input = document.querySelector(`input[name="${fieldName}"][data-passportid="${passportId}"]`);
                if (input) {
                    input.classList.add('update-error-field');
                    if (Object.keys(errors).indexOf(field) === 0) {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
        }
    }
</script>
</html>