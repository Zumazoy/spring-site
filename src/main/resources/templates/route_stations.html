<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Управление промежуточными станциями</title>
  <link rel="stylesheet" href="/style.css">
  <script src="/script.js" defer></script>
</head>
<body>
<div id="errorNotification" class="error-notification"
     th:if="${validationErrors != null and not validationErrors.isEmpty()}">
  <span class="close-btn" onclick="closeErrorNotification()">×</span>
  <strong>Ошибки при добавлении:</strong>
  <ul id="errorList" class="error-list">
    <li th:each="error : ${validationErrors}" th:text="${error.value}"></li>
  </ul>
</div>
<div id="updateErrorNotification" class="error-notification"
     th:if="${updateValidationErrors != null and not updateValidationErrors.isEmpty()}">
  <span class="close-btn" onclick="closeUpdateErrorNotification()">×</span>
  <strong>Ошибки при обновлении:</strong>
  <ul id="updateErrorList" class="error-list">
    <li th:each="error : ${updateValidationErrors}" th:text="${error.value}"></li>
  </ul>
</div>

<header>
  <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
    <a href="/admin" class="admin-btn">← Админ меню</a>
    <h1>Управление промежуточными станциями</h1>
    <div style="width: 100px;"></div>
  </div>
</header>

<div class="container">
  <section class="search-section">
    <h2>Поиск промежуточных станций</h2>
    <form class="search-form" action="/admin/route-stations/search" method="get">
      <input type="text" maxlength="100" name="keyword" placeholder="Введите ключевое слово" th:value="${keyword}" required>
      <select name="searchBy">
        <option value="id" th:selected="${searchBy == 'id'}">ID</option>
      </select>
      <button type="submit">Поиск</button>
      <a href="/admin/route-stations">
        <button type="button">Сбросить поиск</button>
      </a>
    </form>
  </section>

  <section>
    <h2>Добавить промежуточную станцию</h2>
    <form action="/admin/route-stations/add" method="post" th:object="${routeStation}">
      <div class="form-grid">
        <div class="form-group">
          <label>Маршрут</label>
          <select th:field="*{route}" class="form-control">
            <option value="" disabled selected>Выберите маршрут</option>
            <option th:each="route : ${routes}"
                    th:value="${route.id}"
                    th:text="${route.getRoute() + ' (ID: ' + route.id + ')'}"></option>
          </select>
        </div>
        <div class="form-group">
          <label>Станция</label>
          <select th:field="*{station}" class="form-control">
            <option value="" disabled selected>Выберите станцию</option>
            <option th:each="station : ${stations}"
                    th:value="${station.id}"
                    th:text="${station.stationName + ' (ID: ' + station.id + ')'}"></option>
          </select>
        </div>
        <div class="form-group">
          <label>Порядковый номер</label>
          <input type="number" min="1" max="1000" th:field="*{orderNumber}" required>
        </div>
        <div class="form-group">
          <label>Время прибытия</label>
          <input type="time" th:field="*{arrivalTime}" required>
        </div>
        <div class="form-group">
          <label>Время отправления</label>
          <input type="time" th:field="*{departureTime}" required>
        </div>
      </div>
      <button type="submit">Добавить станцию</button>
    </form>
  </section>

  <section>
    <h2>Список промежуточных станций</h2>
    <ol>
      <th:block th:each="routeStation : ${routeStations}">
        <li>
          <div class="user-info">
            <span th:text="'ID: ' + ${routeStation.id} + ' |'"></span>
            <span th:text="'Маршрут: ' + ${routeStation.route.getRoute()} + ' |'"></span>
            <span th:text="'Станция: ' + ${routeStation.station.stationName} + ' |'"></span>
            <span th:text="'Порядок: ' + ${routeStation.orderNumber} + ' |'"></span>
            <span th:text="'Прибытие: ' + ${routeStation.arrivalTime} + ' |'"></span>
            <span th:text="'Отправление: ' + ${routeStation.departureTime}"></span>
          </div>
          <form id="update-form-${routeStation.id}" action="/admin/route-stations/update" method="post">
            <input type="hidden" name="currentPage" th:value="${currentPage}">
            <input type="hidden" name="id" th:value="${routeStation.id}"/>

            <div class="form-grid">
              <div class="form-group">
                <label>Маршрут</label>
                <select name="route.id" class="form-control">
                  <option value="" disabled selected>Новый маршрут</option>
                  <option th:each="route : ${routes}"
                          th:value="${route.id}"
                          th:selected="${route.id == routeStation.route.id}"
                          th:text="${route.getRoute() + ' (ID: ' + route.id + ')'}"></option>
                </select>
              </div>
              <div class="form-group">
                <label>Станция</label>
                <select name="station.id" class="form-control">
                  <option value="" disabled selected>Новая станция</option>
                  <option th:each="station : ${stations}"
                          th:value="${station.id}"
                          th:selected="${station.id == routeStation.station.id}"
                          th:text="${station.stationName + ' (ID: ' + station.id + ')'}"></option>
                </select>
              </div>
              <div class="form-group">
                <label>Порядковый номер</label>
                <input type="number" min="1" max="1000" name="orderNumber" placeholder="Новый порядковый номер"
                       th:attr="data-routestationid=${routeStation.id}" th:value="${routeStation.orderNumber}">
              </div>
              <div class="form-group">
                <label>Время прибытия</label>
                <input type="time" name="arrivalTime"
                       th:attr="data-routestationid=${routeStation.id}" th:value="${routeStation.arrivalTime}">
              </div>
              <div class="form-group">
                <label>Время отправления</label>
                <input type="time" name="departureTime"
                       th:attr="data-routestationid=${routeStation.id}" th:value="${routeStation.departureTime}">
              </div>
            </div>
            <div class="action-buttons">
              <button type="submit">Обновить</button>
              <button type="button" th:onclick="'confirmDelete(' + ${routeStation.id} + ')'" class="btn-danger">Удалить</button>
            </div>
          </form>
          <form th:id="'delete-form-' + ${routeStation.id}" action="/admin/route-stations/delete" method="post" style="display: none;">
            <input type="hidden" name="id" th:value="${routeStation.id}"/>
          </form>
        </li>
      </th:block>
    </ol>

    <div class="pagination" th:if="${totalPages > 1}">
      <!-- Назад -->
      <a th:if="${currentPage > 0}"
         th:href="${(keyword != null and !#strings.isEmpty(keyword)) ?
                 '/admin/route-stations/search?keyword=' + keyword + '&searchBy=' + searchBy + '&page=' + (currentPage - 1) :
                 '/admin/route-stations?page=' + (currentPage - 1)}">← Назад</a>

      <!-- Номера страниц -->
      <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                <a th:if="${i != currentPage}" class="pages"
                   th:href="${(keyword != null and !#strings.isEmpty(keyword)) ?
                             '/admin/route-stations/search?keyword=' + keyword + '&searchBy=' + searchBy + '&page=' + i :
                             '/admin/route-stations?page=' + i}"
                   th:text="${i + 1}"></a>
                <span class="currentPage" th:if="${i == currentPage}" th:text="${i + 1}"></span>
            </span>

      <!-- Вперед -->
      <a th:if="${currentPage < totalPages - 1}"
         th:href="${(keyword != null and !#strings.isEmpty(keyword)) ?
                 '/admin/route-stations/search?keyword=' + keyword + '&searchBy=' + searchBy + '&page=' + (currentPage + 1) :
                 '/admin/route-stations?page=' + (currentPage + 1)}">Вперед →</a>
    </div>
  </section>
</div>
</body>
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
    const errors = /*[[${validationErrors}]]*/ {};
    if (errors && Object.keys(errors).length > 0) {
      highlightAddErrorFields(errors);
      showErrorNotification(errors);
    }

    const updateErrors = /*[[${updateValidationErrors}]]*/ {};
    if (updateErrors && Object.keys(updateErrors).length > 0) {
      highlightUpdateErrorFields(updateErrors);
      showUpdateErrorNotification(updateErrors);
    }
  });

  function highlightAddErrorFields(errors) {
    document.querySelectorAll('.add-error-field').forEach(el => {
      el.classList.remove('add-error-field');
    });

    for (const field in errors) {
      const input = document.querySelector(`form[action='/admin/route-stations/add'] [name="${field}"],
                                              form[action='/admin/route-stations/add'] [th\\:field="*{${field}}"]`);
      if (input) {
        input.classList.add('add-error-field');
        if (Object.keys(errors).indexOf(field) === 0) {
          input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }
  }

  function highlightUpdateErrorFields(errors) {
    document.querySelectorAll('.update-error-field').forEach(el => {
      el.classList.remove('update-error-field');
    });

    for (const field in errors) {
      const parts = field.split('_');
      if (parts.length >= 3 && parts[0] === "update") {
        const fieldName = parts[1];
        const routeStationId = parts[2];

        const input = document.querySelector(`input[name="${fieldName}"][data-routestationid="${routeStationId}"],
                                                  textarea[name="${fieldName}"][data-routestationid="${routeStationId}"]`);
        if (input) {
          input.classList.add('update-error-field');
          if (Object.keys(errors).indexOf(field) === 0) {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      }
    }
  }
</script>
</html>